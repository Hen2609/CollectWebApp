const express = require('express')
const ejs = require('ejs');
const bodyParser = require('body-parser')
const mongoSanitize = require('express-mongo-sanitize')
const session = require('express-session')


const app = express()

const routes = require("./src/routes")

const port = process.env.NODE_DOCKER_PORT || 8080;


app.set('view engine', 'ejs');
app.set("views", "./src/views")
app.use(bodyParser.urlencoded({extended: true, limit: '10mb' }))
app.use(bodyParser.json())

app.use(mongoSanitize())
app.use(session({
  secret: process.env.WEB_APP_COOKIE_SECRET,
  resave: false,
  saveUninitialized: true,
  cookie: {
    httpOnly: true,
  }
}))
app.use(express.static('public'))
app.use('/', routes)


const formData = require('form-data');
const Mailgun = require('mailgun.js');
const mailgun = new Mailgun(formData);
const mg = mailgun.client({username: 'api', key: process.env.MAILGUN_KEY });
const img = "data:image/webp;base64,UklGRvQXAABXRUJQVlA4IOgXAAAQEQKdASqABzgEPm02m0mkI6KhINZIEIANiWlu/D036Eaiv69zG4Vs+c/43tH9Ea1wI78p7jXZH+9cfW9o+vlYf1fVHVcvu/RU//fnb/hwHvDzmnuNPeaazp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06OqTH/h5zT3GnvNNZ06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTo5LpQHv0YNXUCZCNbdtwXvNNZ06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTpvxFMRDziHnESEZKnun1NqbUorbq+nTpvnQAWYegCug+Z/cA9Domnram1KJu4iVRTF1NqUTQP19OnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dN9vPalbjxhVqVZX029fTp0306RoX7NHM8y2GVRvP7pjC/+4WRbQn1NfjeGgij2ms6dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTfbea3PO29bomD3mms3wzdrYU64O3noAHXv2LhzEvqJfUTB7zTWdOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTo6JfUUa0TBopLw85p7WQdJXqSV0oQl3Yh7WsXDmJfUS+omD3mms6dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnR0S+oo1omDRSXh5zT3EQ5oh7y/ZIt5fgfq1axcOYl9RL6iYPeaazp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dHRL6iX0kWiqAo29fTp06b4lUML0Cv5ONjVBYlow8qktC2tVW2kxB9faazp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOm+eh/FNjPB29boN03c6MqEWrZS6vp7jT0LJQgy/CFgRzRi/D0wCwxGZoIpOW6WLeRFWpNMjVt9D2ms6dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTfUB4Mfm1GChbaYY6+MYtyKGKr6e409AK1oYMjkRVdAs2mXBjSXWxSteIuKpKsq3JBcBT3GnvNNZ06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp03zwJJN4fb7XC9A1v768NMGvOfH3UAEH//Sl1p9QOBCIaAegnCtCasQ5JVK6ASy0UPgaKUPaRtkKlYuoVca0POae4095prOnTp06dOnTp06dOnTp06dOnTp06dOnTp06OTxkwLUm28QGvEmOZTJ9pZJKEGaT/NxTWuhIAb7J/piLQnNB6RG8kCqKtUta99JFkbLP6aEGzQr2zTumRRezA1il9LA4s6wbsVcAjR/ARBLG/RulS6azp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnR2Ia3qL/tvUNM0cTe8d4wge37L6eVpjtU2jNKr1S+4t6bKVajW9RVfT3GnvNNZ06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTfSKpveWDK+Da09rJrxp0O43F5prOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06b8koQZpP0OeqEO/wPunmNPQbIcmwMomyLV9Pcae801nTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTfRqEFE9+UGlTtApffwQ586dHMJ6NQWSlFfTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp2zqKr6eU7r7ymSUor6dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dHMflqCklKK+nTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnRzVzfUdc2Ravp7jT3mms6dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06Oc5CoUnFtXY9prOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dHNUMXALM4UcvT3GnvNNZ06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp0csDaq81/B6eSZedOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOm/AAO3/1BEndYRbUXw9nE54PtSnP86M+QPOae4095prOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dHDjBGnBSPLAbI3pxUre1g4/fSpQb6p66qms6dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06OsAPHpMncKHfWUaXQv4wBgdACKgzVKvp7jT3mms6dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp035dGFWkLQNIQHo5ZFdS4gNDPJynt7jT3mms6dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOm+MiKd0qigFSThN7/LRxFECCaTvKHosAxlAPeaazp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOjiM+1UFQ1CWqICKHQpQzOCgyiV6L7CuqXAKe801nTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOm+KQIFEbAUAKiPlrXD1y6Wd7uBbWW9Kl5prOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOjkuXiynHCmIczoVCmIPDtjJ0wGXn2ACQZX5ZzT3GnvNNZ06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06b4yc0MJBpBifJHo0VY5mjia03uFJWTI7E1FV9Pcae801nTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnRxD+Cb5ZHw9f0HCm3YoI1mM8LPLRyBSdjq+kbUtRoe01nTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTo4KLVnTo4dKT/ERuvbXdlwe01nTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp2zqKr6e4095prOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp06dOnTp0cAAD+/9laAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIBZM3HuWXjk9ASgAACgLra8Aje5bjpZflog3UaZM59A5hOV1i4diiy5bzK9EJG+3h32pkpXl6RRlnYyXmcxwQlOSAAAH36T65P16I4i8OlKBP4O061Cctms/JknNl51NHPFazXtNmVXYs8RCyTuvST6ymtU4QC9Nk0TnWyB2gxXZJpw6UoE9tSPkAAPH2OJgwFFSHW4mpiLGG3nm4Wg7+ExjVipKJhZpX04W70BB5jR0Yi4WBjBT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"
mg.messages.create('sandboxeded159a31d94b54b535b948df6548b3.mailgun.org', {
  from: "Excited User <mailgun@sandboxeded159a31d94b54b535b948df6548b3.mailgun.org>",
  to: ["chen.zilberman@gmail.com"],
  subject: "Hello",
  text: "Testing some Mailgun awesomeness!",
  html: `
    <h1>מוצר חדש ומדהים</h1>
  `,
  attachments: [
    {
      filename: 'image.png',
      path: img,
      cid: 'image123' // cid must be equal to the one provided in html above
    }
  ]
})
    .then(msg => console.log(msg)) // logs response data
    .catch(err => console.log(err)); // logs any error



app.listen(port, () => {
  console.log(`Example app listening on port ${port}`)
})